name: Deploy to Linux Server

on:
  push:
    branches: ["main"]

env:
  APP_NAME: discord-domi-bot
  APP_DIR: /opt/docker/discord-domi-bot
  APP_PORT: 5539

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # üîë SSH ÌÇ§ ÏÑ§Ï†ï
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat <<EOF > ~/.ssh/id_rsa \
          ${{ secrets.SSH_PRIVATE_KEY }} << 'EOF'
          chmod 600 ~/.ssh/id_rsa
      
          ssh-keyscan -T 5 -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true
      - name: Check SSH key
        run: |
          ls -l ~/.ssh
          head -n 3 ~/.ssh/id_rsa
      - name: Test SSH
        run: |
          ssh -i ~/.ssh/id_rsa \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "whoami; hostname"
      # üöÄ ÏÑúÎ≤Ñ Î∞∞Ìè¨
      - name: Deploy
        run: |
          ssh -i ~/.ssh/id_rsa -vvv -o StrictHostKeyChecking=no \ 
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} -p ${{ secrets.SERVER_PORT }} << 'EOF'

          set -e

          mkdir -p "$APP_DIR"
          cd "$APP_DIR"

          if [ ! -d ".git" ]; then
            git clone https://github.com/HDomi/discord-domi-bot.git .
          else
            git pull origin main
          fi

          docker stop "$APP_NAME" || true
          docker rm "$APP_NAME" || true

          docker build -t "$APP_NAME:latest" .

          docker run -d \
            --restart unless-stopped \
            --name "$APP_NAME" \
            -p "$APP_PORT:$APP_PORT" \
            -e DISCORD_TOKEN='${{ secrets.DISCORD_TOKEN }}' \
            -e CLIENT_ID='${{ secrets.CLIENT_ID }}' \
            -e STEAM_API='${{ secrets.STEAM_API }}' \
            -e FIREBASE_API_KEY='${{ secrets.FIREBASE_API_KEY }}' \
            -e FIREBASE_AUTH_DOMAIN='${{ secrets.FIREBASE_AUTH_DOMAIN }}' \
            -e FIREBASE_DATABASE_URL='${{ secrets.FIREBASE_DATABASE_URL }}' \
            -e FIREBASE_PROJECT_ID='${{ secrets.FIREBASE_PROJECT_ID }}' \
            -e FIREBASE_STORAGE_BUCKET='${{ secrets.FIREBASE_STORAGE_BUCKET }}' \
            -e FIREBASE_MESSAGING_SENDER_ID='${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}' \
            -e FIREBASE_APP_ID='${{ secrets.FIREBASE_APP_ID }}' \
            -e FIREBASE_MEASUREMENT_ID='${{ secrets.FIREBASE_MEASUREMENT_ID }}' \
            -e FIREBASE_USER_KEY='${{ secrets.FIREBASE_USER_KEY }}' \
            "$APP_NAME:latest"

          EOF
